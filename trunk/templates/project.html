{% extends "./partials/base.html" %}

{% block title %}
Change by Us - Project
{% endblock title %}


{% block project_admin %}
{{ super() }}
	<li class="feature"><a href="#featureProject,{{ d.template_data.project.data.project_id }}" class="fancy-caps">Feature <span>this</span> project</a></li>
	<li class="delete"><a href="#deleteProject,{{ d.template_data.project.data.project_id }}" class="fancy-caps">Delete <span>this</span> project</a></li>
{% endblock %}

{% block continent %}

<div class='continent project'>

	<div class='headlands clearfix project-header'>
		<div class="green-nyc-project-tag">
			<span>Official Project</span>
		</div>
		<div class="thumb">
			{% if d.template_data.project_user.data.is_project_admin %}
			<a class="change-image"><span>Change Photo</span></a>
			{% endif %}
			{% if d.template_data.project.data.info.image_id %}
				<img width='100' src='/images/{{ d.template_data.project.data.info.image_id % 10 }}/{{ d.template_data.project.data.info.image_id }}.png' alt="" class='proj'/>
			{% else %}
				<img width='100' src="/static/images/thumb_genAvatar100.png" alt="" class="proj"/>
			{% endif %}
			
			<span class="overlay-tag"></span>
		</div>
		<div class="tools">
			{%  if not d.template_data.project_user.data.is_member %}
				<a class="ca-btn join-project" href="#">
					<span>Join</span>
				</a>
			{%  endif %}
			<div class="members {% if d.template_data.project.data.info.members['items']|length > 0 %}has-members{% endif %}">
				<a href="#show,members">
					Members <span class="counter members-counter">{{ d.template_data.project.data.info.members['items']|length }}</span>
				</a>
			</div>
			{% if d.template_data.project_user.data.is_project_admin %}
				<span class="control"><a href="#show,members">Manage</a></span>
			{% endif %}
			{% if d.template_data.project_user.data.is_member %}
				{% if not(d.template_data.project_user.data.is_project_admin) %}
				<span class="control"><a href="">Leave <span class="uncaps">this</span> project</a></span>
				{% endif %}
			{% endif %}
		</div>
		<div class="main">
			<h1><a href='#project-home'>{{ d.template_data.project.data.info.title }}</a></h1>
			<cite class="meta">
				<span class="fancy-caps">Created <span>by</span></span> <strong><a href='/useraccount/{{ d.template_data.project.data.info.owner.u_id }}'>{{ d.template_data.project.data.info.owner.name }}</a></strong>
			</cite>
			<div class="sub-ft">
				<div class="twitter">
					<a href="http://twitter.com/share" class="twitter-share-button" data-count="none">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
				</div>
				<div class="facebook">
					<script src="http://connect.facebook.net/en_US/all.js#xfbml=1"></script>
					<fb:like layout="button_count" show_faces="true" width="100"></fb:like>
				</div>
			</div>
		</div>
	</div><!-- end .headlands -->

	<div class='midlands clearfix'>
		<div class="east">
			{% if d.template_data.project_user.data.is_member %}
				<div class="members-empty" style="{% if d.template_data.project.data.info.members['items']|length > 1 %}display:none;{% endif %}">
					<span class="tail"></span>
					<div class="empty-state-box big">
						<a class="close" href="#"><span>Close</span></a>
						<p><a href="#show,members">Find people</a> to be your project members!</p>
					</div>
				</div>
			{% endif %}
			{% include 'project/related_resources.html' %}
			{% include 'project/add_link.html' %}
			{% include 'project/goals_main.html' %}
			{% include 'project/goals_add.html' %}
			{% include 'project/goals_stack.html' %}
			{% include 'project/conversation.html' %}
			{% include 'project/members.html' %}
		</div>
		<div class="west">
			{% include 'project/mission.html' %}
			{% include 'project/resources.html' %}
			{% include 'project/fresh_ideas.html' %}
		</div>
	</div>

	<div class='foothills'>

	</div>

	<div class='template-content modal-content introduce-yourself'>
		<div class='step introduce-message-step'>
			<form action='#'>
				<div class='box note-card'>
					<cite class="note-meta-hd">
						<strong>You</strong> say &ndash;
					</cite>
					<textarea name='introduce-message' class='introduce-message serif'></textarea>
				</div>
				<div class='box'>
					<h2><strong>Introduce</strong> yourself to the project team.</h2>
					<h3>What's your idea for this project?</h3>
					<a href="#" class='submit rounded-button'>Send</a>
				</div>
			</form>
		</div>
	
		<div class='step finish'>
			<p>Thanks for introducing yourself&hellip;</p>
			<p><img src='/static/images/loader32x32.gif' /></p>
		</div>
	
		<a class='close' href="#"><span>close</span></a>
	</div>
	
	<div class='template-content modal-content join-no-user'>
		<h2><strong>Hold your horses!</strong> Please register.</h2>
		<p>You must <strong><a href='/join'>register</a></strong> or <strong><a href='/login'>login</a></strong> with Change by Us in order to Join a project.</p>
		<a class='close' href="#"><span>close</span></a>
	</div>
	
	<div class="template-content modal-content confirm-delete member-delete">
		<div class="step">
			<h2><strong>Delete</strong> this Project Member?</h2>
			<div>
				<p>You are about to delete <span class="person-name serif">XXXXXX</span> from the system permanently! <br/>Are you sure?</p>
			</div>
			<div class="actions">
				<a class="submit rounded-button" href="#">Yes, Delete <span class="person-name serif">XXXXXX</span></a>
				<a class="cancel" href="#">No, keep them.</a>
			</div>
		</div>
		<a class='close' href="#"><span>close</span></a>
	</div>
	
	<div class='template-content modal-content upload-image'>
		<div class='step'>
			<h2><strong>Upload</strong> a photo for your project.</h2>
			<div>
				<p>Photos should be <strong>under 1MB</strong> please. (We also crop photos to <strong>90px by 90px</strong>)</p>
			</div>
			<div class="file-uploader"></div>
		</div>
		<a class='close' href="#"><span>close</span></a>
	</div>
	
	{% if d.template_data and d.template_data.user and d.template_data.user.is_admin %}
		<!-- feature this project merlin template -->
		<div class="template-content modal-content merlin feature-project-dialog">
			<div class="step feature-this-project">
				<h2><strong>Feature</strong> This Project</h2>
				<div class="">
					Do you want to replace
					<select>
						<option value="-1"></option>
					</select>
					with <span class="serif"></span>
					in the Featured Projects section on the homepage?
				</div>
				<div class="actions">
					<a class="submit rounded-button" href="#">Yes</a>
					<a class="cancel rounded-button" href="#">Cancel</a>
				</div>
			</div>
			<div class="step feature-this-project-submit">
				
			</div>
			<a class='close' href="#"><span>close</span></a>
		</div>
	{% endif %}

</div><!-- end .continent.project -->
{% endblock continent %}


{% block page_js %}
<script src="/static/js/prettyCheckboxes.js" type="text/javascript"></script>
<script>
	{% if d.template_data and d.template_data.project %}
		app_page.data.project = {{ d.template_data.project.json }};
	{% else %}
		app_page.data.project = null;
	{% endif %}

	app_page.features.push(function(app){
		tc.util.log('Give A Minute: Project');
		
		tc.util.log(' ');
		tc.util.log('PROJECT DATA!!!');
		tc.util.dump(app.app_page.data.project);
		tc.util.log("PROJECT USER");
		tc.util.dump(app.app_page.project_user);
		tc.util.log(' ');
		
		app.components.project = new tc.gam.project({
			app:app,
			data:app_page.data.project,
			project_user:app_page.project_user,
			dom:tc.jQ('.continent.project')
		});
		
		tc.jQ(document).unbind('create-image-uploaded').bind('create-image-uploaded', {app:app, project:app.components.project}, function(e, d){
			e.data.app.components.modal.hide()
			if(d.responseJSON.thumbnail_id){
				tc.jQ.ajax({
					type:'POST',
					url:'/project/photo',
					data:{
						project_id:e.data.project.data.project_id,
						image_id:d.responseJSON.thumbnail_id
					},
					dataType:'text',
					success:function(data,ts,xhr){
						tc.jQ('img.proj').attr('src','/images/'+(d.responseJSON.thumbnail_id % 10)+'/'+d.responseJSON.thumbnail_id+'.png');
					}
				});
			}
		});
		
		tc.jQ('a.change-image').bind('click',{
			app:app,
			source_element:tc.jQ('.modal-content.upload-image'),
			init:function(modal,callback){
				var uploader = new qq.FileUploader({
					element: modal.options.element.find('.file-uploader').get(0),
					action: '/create/photo',
					onComplete: function(id, fileName, responseJSON){
						
						tc.jQ(document).trigger('create-image-uploaded',{
							id:id,
							fileName:fileName,
							responseJSON:responseJSON
						});
						
						return true;
					}
				});
				if(tc.jQ.isFunction(callback)){
					callback(modal);
				}
			}
		},function(e,d){
			e.preventDefault();
			e.data.app.components.modal.show(e.data);
		});
		
		// Join
		tc.jQ('a.join-project').bind('click',{
			app:app,
			no_user:{
				source_element:tc.jQ('.modal-content.join-no-user'),
				init:function(modal,event_target,callback){
					
					if(tc.jQ.isFunction(callback)){
						callback(modal);
					}
				}
			},
			user:{
				source_element:tc.jQ('.modal-content.introduce-yourself'),
				init:function(modal,event_target,callback){
					var modal_merlin;
					modal_merlin = new tc.merlin(app,{
						dom:modal.options.element.find('.introduce-yourself'),
						first_step:'introduce-message-step',
						data:{
							project_id:app.app_page.data.project.project_id,
							message:null
						},
						steps:{
							'introduce-message-step':{
								selector:'.introduce-message-step',
								inputs:{
									message:{
										selector:'textarea.introduce-message',
										validators:['max-200']
									}
								},
								init:function(merlin,dom){
									dom.find('.submit').bind('click',{merlin:merlin,dom:dom},function(e,d){
										e.preventDefault();
										if(dom.hasClass('invalid')){
											return;
										}
										window.location.hash = 'finish';
									});
								},
								finish:function(merlin,dom){
									merlin.options.data.message = merlin.current_step.inputs.message.dom.val();
								}
							},
							'finish':{
								selector:'.finish',
								init:function(merlin,dom){
									tc.jQ.ajax({
										type:'POST',
										url:'/project/join',
										data:merlin.options.data,
										context:merlin,
										dataType:'text',
										success:function(data,ts,xhr){
											location.reload(true);
										}
									});
								}
							}
						}
					});
					if(tc.jQ.isFunction(callback)){
						callback(modal);
					}
				}
			}
		},function(e,d){
			if(!e.data.app.app_page.user){
				e.data.app.components.modal.show(e.data.no_user, e.target);
			} else {
				e.data.app.components.modal.show(e.data.user, e.target);
			}
		});
		
		tc.gam.ideas_invite( app );
		
		{% if d.template_data and d.template_data.user and d.template_data.user.is_admin %}
			tc.jQ(".adminbar > .feature a").bind("click", {
					app: app,
					source_element: tc.jQ(".modal-content.feature-project-dialog"),
					init: function(modal, event_target, callback) {
						var modal_merlin;
						modal_merlin = new tc.merlin(app, {
							name: "feature_project",
							dom: modal.options.element.find(".feature-project-dialog"),
							next_button: modal.options.element.find(".actions .submit"),
							first_step: "feature-this-project",
							data: {
								project_id: app.app_page.data.project.project_id,
								replace_project_id: null
							},
							steps: {
								"feature-this-project": {
									selector: ".feature-this-project",
									next_step: "feature-this-project-submit",
									init: function(merlin, dom) {
										
									},
									finish: function(merlin, dom) {
										
									}
								},
								"feature-this-project-submit": {
									selector: ".feature-this-project-submit",
									init: function(merlin, dom) {
										
									}
								}
							}
						});
						if (tc.jQ.isFunction(callback)) {
							callback(modal);
						}
					}
				},
				function(e,d){
					e.preventDefault();
					e.data.app.components.modal.show(e.data, e.target);
				}
			);
		{% endif %}
	});
</script>

<script type="text/javascript" src="/static/js/libs/jqdropdown.js"></script>
<script type="text/javascript">
	tc.jQ(function() {  
		tc.jQ("select.duration").jqDropDown({ 
			direction: 'down',
			placeholder: '.duration'
		});
		tc.jQ("select.point_person").jqDropDown({ 
			direction: 'down',
			placeholder: '.point_person'
		});
	});
</script>

<!--[if lte IE 8]>
	<script type="text/javascript">
		$('.headlands .thumb').hover(
			function () { tc.jQ('.change-image').addClass('hover'); },
			function () { tc.jQ('.change-image').removeClass('hover'); }
		);
	</script>
<![endif]-->
{% endblock page_js %}