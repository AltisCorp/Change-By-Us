<div class="box conversation">
	
	{% if (d.template_data.project_user.data.is_member or d.template_data.project_user.data.is_project_admin) or (d.template_data.user and (d.template_data.user.data.is_admin or d.template_data.user.data.is_leader)) %}
	
		<!-- begin .conversation-controls -->
		<div class="conversation-controls clearfix">
			<a class="rss-btn" href="#"><span><abbr>RSS</abbr></span></a>
		
			{% if d.template_data.project.data.info.messages['total'] > 0 %}
				
				<div class="filters">
					<select class='message_filter_select'>
						<option selected='true' value='all'>All Messages</option>
						<option value='member_comment'>Member Comments</option>
						<option value='admin_comment'>Admin Comments</option>
						<option value='goal_achieved'>Goal Achieved</option>
						<option value='join'>Join</option>
						<option value='endorsement'>Endorsement</option>
					</select>
				</div>
				
			{% endif %}
		
			<div class="main merlin submit-message">
				<div class='step message clearfix'>
					<div class="conversation-input">
						{% if d.template_data.project.data.info.messages['total'] > 0 %}
							<label class="fancy-caps">Join <span>the</span> Conversation</label>
						{% else %}
							<label class="fancy-caps">Start <span>the</span> Conversation</label>
						{% endif %}
						<textarea class='message-input' cols="48" rows="1"></textarea>
						<p class="hint">Post your update as a comment or add links to photos and videos.</p>
					</div>
					<div class="primary-action">
						<a class="ca-btn submit-button" href="#">
							<span>Post</span>
						</a>
					</div>
				</div>
				<div class='step submit clearfix spinner-message' style='display:none;'>
					<p>Thank you for submitting a message!</p>
					<p><img src='/static/images/loader32x32.gif' /></p>
				</div>
			
				<div class='step submit-error clearfix' style='display:none;'>
					<p>There was an error submitting your message!</p>
				</div>
			</div>
		</div>
		<!-- end .conversation-controls -->
	{% endif %}
	
	<ol class="comment-stack">
		{% if d.template_data.project.data.info.messages['n_returned'] > 0 %}
			{% for message in d.template_data.project.data.info.messages['items'] %}
				<li class=" " id='message-{{ message.message_id }}'>
					{% if d.template_data.project_user.data.is_project_admin %}
						<a class="close" href="#remove,{{ message.message_id }}"><span>Close</span></a>
					{% endif %}
					<div class="membrane">
						<div class="thumb">
							{% if message.owner.image_id %}
								<img src='/images/{{ message.owner.image_id % 10 }}/{{ message.owner.image_id }}.png' alt=""/>
							{% else %}
								<img src="/static/images/thumb_genAvatar.jpg" alt=" " class="avatar"/>
							{% endif %}
						</div>
						<div class="main">
							{% if message.message_type == 'join' %}
								<cite class="meta-hd"><strong>{{ message.owner.name }}</strong> joined the project!</cite>
							{% elif message.message_type == 'goal_achieved' %}
							
							{% elif message.message_type == 'endorsement' %}
								
							{% elif message.message_type == 'member_comment' or message.message_type == 'admin_comment' %}
								<cite class="meta-hd"><strong>{{ message.owner.name }}</strong> said</cite>
							{% endif %}
						
							{% if message.idea %}
								<div class="note-card">
									<cite class="note-meta-hd"></cite>
									<blockquote>
										<p>{{ message.idea.text }}</p>
									</blockquote>
									<cite class="note-meta-ft"></cite>
								</div>
							{% endif %}
						
							<blockquote class="serif">
								<p>{{ message.body }}</p>
							</blockquote>
							<!-- TODO calculate time since based on {{ message.created }} -->
							<!--<cite class="meta-ft">XXXX ago</cite>-->
							<cite class="meta-ft">Created {{ message.created }}</cite>
						</div>
					</div>
				</li>
			{% endfor %}
		{% endif %}
	</ol>
	
	<div class="load-more" {% if d.template_data.project.data.info.messages['n_returned'] < 10 %} style='display:none;' {% endif %}>
		<a href="#" class='load_more_button'><span>Older Posts</span></a>
	</div>
	
</div>

<li class='template-content message-markup'>
	{% if d.template_data.project_user.data.is_project_admin %}
		<a class="close" href="#"><span>Close</span></a>
	{% endif %}
	<div class="membrane">
		<div class="thumb">
			<img src="/static/images/thumb_genAvatar.jpg" alt=" " class="avatar"/>
		</div>
		<div class="main">
			<!-- <cite class="meta-hd"><strong></strong> joined the project!</cite> -->
			<!-- <cite class="meta-hd"><strong>XXXX XXXX</strong> says</cite> -->
			<blockquote class="serif">
				<p class='message-body'></p>
			</blockquote>
			<cite class="meta-ft">Just Now&hellip;</cite>
		</div>
	</div>
</li>

<div class='template-content modal-content add-message-no-user'>
	<p>You must <a href='/join'>register</a> or <a href='/login'>login</a> with Change by Us in order to add a goal to this project.</p>
	<a class='close' href="#"><span>close</span></a>
</div>

<div class="template-content modal-content confirm-delete remove-message">
	<div class="step">
		<h2><strong>Delete</strong> this Message?</h2>
		<div>
			<p>This deletes the message from the system permanently! <br/>Are you sure?</p>
		</div>
		<div class="actions">
			<a class="submit rounded-button" href="#">Yes, Delete Message</a>
			<a class="cancel" href="#">No, keep them.</a>
		</div>
	</div>
	<a class='close' href="#"><span>close</span></a>
</div>

<script>
	if(!tc){ var tc = {}; }
	if(!tc.gam){ tc.gam = {}; }
	if(!tc.gam.project_widgets){ tc.gam.project_widgets = {}; }
	tc.gam.project_widgets.conversation = function(project,dom,deps,options){
		var widget, me;
		tc.util.log("project.conversation");
		this.options = tc.jQ.extend({name:'conversation'},options);
		this.dom = dom;
		widget = tc.gam.widget(this,project);
		me = this;
		this.components = {
			merlin:null
		};
		
		this.runtime_data = {
			message_filter:'all',
			n_to_fetch:10,
			offset:{{ d.template_data.project.data.info.messages['items']|length }},
			message_template:tc.jQ('.template-content.message-markup').clone().removeClass('template-content')
		};
		
		this.elements = {
			userprompt: this.dom.find(".conversation-input label"),
			textpane: this.dom.find(".conversation-input textarea"),
			message_stack:this.dom.find("ol.comment-stack"),
			load_more_button:this.dom.find('.load_more_button')
		};
		
		this.handlers = {
			userprompt_click: function(e, d) {
				e.data.me.elements.textpane.focus();
			},
			add_new_message:function(e,d){
				var message;
				message = generate_message_markup(d);
				message.hide();
				e.data.me.elements.message_stack.prepend(message);
				e.data.me.dom.find('a.close').unbind('click').bind('click', {project:project,me:e.data.me}, e.data.me.handlers.remove_comment);
				message.slideDown(500);
			},
			change_message_filter:function(e,d){
				
				e.data.me.elements.message_stack.children().remove();
				e.data.me.runtime_data.offset = 0;
				e.data.me.runtime_data.message_filter = tc.jQ(e.target).val();
				
				tc.jQ.ajax({
					type:"GET",
					url:"/project/messages",
					data:{
						project_id: e.data.me.options.app.app_page.data.project.project_id,
						n_messages: e.data.me.runtime_data.n_to_fetch,
						offset: e.data.me.runtime_data.offset,
						filter: e.data.me.runtime_data.message_filter
					},
					context:e.data.me,
					dataType:"text",
					success: function(data, ts, xhr) {
						var d, tempdom;
						try {
							d = tc.jQ.parseJSON(data);
						} catch(e) {
							tc.util.log("/useraccount/messages: json parsing error", "warn");
							return;
						}
						if (!d.length) {
							return;
						} else if(d.length < this.runtime_data.n_to_fetch){
							this.elements.load_more_button.animate({
								opacity:0.0
							});
						}
						for(i in d){
							tempdom = this.runtime_data.message_template.clone().removeClass('message-markup');
							if(d[i].owner.image_id){
								tempdom.find('img').attr('src','/images/'+(d[i].owner.image_id%10)+'/'+d[i].owner.image_id+'.png' );
							} else {
								tempdom.find('img').attr('src','/static/images/thumb_genAvatar.jpg');
							}
							
							tempdom.attr('id','message-'+d[i].message_id);
							tempdom.find('.meta-ft').text(d[i].created);
							tempdom.find('.message-body').text(d[i].body);
							tempdom.find('a.close').attr('href','#remove,'+d[i].message_id);
							this.elements.message_stack.append(tempdom);
							this.runtime_data.offset++;
						}
						this.dom.find('a.close').unbind('click').bind('click', {project:project,me:this}, this.handlers.remove_comment);
					}
				});
				
				
			},
			load_more_button_click:function(e, d){
				e.preventDefault();
				tc.jQ.ajax({
					type:"GET",
					url:"/project/messages",
					data:{
						project_id: e.data.me.options.app.app_page.data.project.project_id,
						n_messages: e.data.me.runtime_data.n_to_fetch,
						offset: e.data.me.runtime_data.offset,
						filter: e.data.me.runtime_data.message_filter
					},
					context:e.data.me,
					dataType:"text",
					success: function(data, ts, xhr) {
						var d, tempdom;
						try {
							d = tc.jQ.parseJSON(data);
						} catch(e) {
							tc.util.log("/useraccount/messages: json parsing error", "warn");
							return;
						}
						if (!d.length) {
							return;
						} else if(d.length < this.runtime_data.n_to_fetch){
							this.elements.load_more_button.animate({
								opacity:0.0
							});
						}
						for(i in d){
							tempdom = this.runtime_data.message_template.clone().removeClass('message-markup');
							if(d[i].owner.image_id){
								tempdom.find('img').attr('src','/images/'+(d[i].owner.image_id%10)+'/'+d[i].owner.image_id+'.png' );
							} else {
								tempdom.find('img').attr('src','/static/images/thumb_genAvatar.jpg');
							}
							
							tempdom.attr('id','message-'+d[i].message_id);
							tempdom.find('.meta-ft').text(d[i].created);
							tempdom.find('.message-body').text(d[i].body);
							tempdom.find('a.close').attr('href','#remove,'+d[i].message_id);
							this.elements.message_stack.append(tempdom);
							this.runtime_data.offset++;
						}
						this.dom.find('a.close').unbind('click').bind('click', {project:project,me:this}, this.handlers.remove_comment);
					}
				});
				
			},
			remove_comment:function(e){
				e.preventDefault();
				
				e.data.project.options.app.components.modal.show({
					app:e.data.project.options.app,
					source_element:tc.jQ('.modal-content.remove-message'),
					submit:function(){
						tc.jQ.ajax({
							type:'POST',
							url:'/project/message/remove',
							data:{
								project_id: e.data.me.options.app.app_page.data.project.project_id,
								message_id: e.target.href.split(',')[1]
							},
							context:e.data.me,
							dataType:'text',
							success:function(data,ts,xhr){
								if(data == 'False'){
									return false;
								}
								this.dom.find('#message-'+e.target.href.split(',')[1]).slideUp();
								this.runtime_data.offset--;
							}
						});
					}
				});
			}
		};
		
		project.dom.bind('add-new-message',{me:this},this.handlers.add_new_message);
		this.elements.load_more_button.bind('click', { project:project,me:this }, this.handlers.load_more_button_click);
		if (this.elements.userprompt.length) {
			this.elements.userprompt.bind("click", { project:project,me:this },this.handlers.userprompt_click);
		}
		if (this.elements.textpane.length) {
			this.elements.textpane.autoGrow();
		}
		this.dom.find('select.message_filter_select').unbind('change').bind('change', {project:project,me:this}, this.handlers.change_message_filter);
		this.dom.find('a.close').unbind('click').bind('click', {project:project,me:this}, this.handlers.remove_comment);
		
		function generate_message_markup(data){
			tc.util.dump(data);
			var markup;
			markup = tc.jQ('.template-content.message-markup').clone().removeClass('template-content');
			markup.attr('id','message-'+data.message_id);
			//markup.find('img').attr('src','/images/'++'/'++'.png')
			markup.find('a.close').hide();//.attr('href','#remove,'+data.message_id);
			markup.find('p.message-body').text(data.message);
			return markup;
		}
		
		{% if (d.template_data.project_user.data.is_member or d.template_data.project_user.data.is_project_admin) or (d.template_data.user and (d.template_data.user.data.is_admin or d.template_data.user.data.is_leader)) %}
		
			this.build_merlin = function(){
				//if(!options.app.app_page.user){
				//	options.app.components.modal.show({
				//		source_element:tc.jQ('.modal-content.add-message-no-user'),
				//		init:function(modal,callback){
				//			if(tc.jQ.isFunction(callback)){
				//				callback(modal);
				//			}
				//		}
				//	});
				//	return false;
				//}
				tc.util.log('conversation.build_merlin')
				if(this.components.merlin){
					return;
				}
				this.components.merlin = new tc.merlin(options.app,{
					name:'project_conversation',
					dom:dom.find('.merlin.submit-message'),
					next_button:dom.find('a.submit-button'),
					first_step:'message',
					data:{
						message:null,
						project_id:null
					},
					steps:{
						'message':{
							selector:'.step.message',
							next_step:'message-submit',
							inputs:{
								message:{
									selector:'textarea.message-input',
									validators:['min-3','max-200','required'],
									hint:'',
									handlers:{
										focus:function(e,d){
											if (tc.validator_utils.isEmpty(tc.jQ(this).val())) {
												e.data.me.dom.find(".conversation-input label").hide();
											}
										},
										blur:function(e,d){
											if (tc.validator_utils.isEmpty(tc.jQ(this).val())) {
												e.data.me.dom.find(".conversation-input label").show();
											}
										}
									}
								}
							},
							init:function(merlin,dom){
								merlin.current_step.inputs.message.dom.val('').removeClass('has-been-focused').removeClass('has-attempted-submit');
							},
							finish:function(merlin,dom){
								tc.util.dump(merlin.current_step.dom.height());
								merlin.dom.find('.step.submit').css('height',merlin.current_step.dom.height())
								merlin.options.data = tc.jQ.extend(merlin.options.data,{
									project_id:merlin.app.app_page.data.project.project_id,
									message:merlin.current_step.inputs.message.dom.val()
								});
							}
						},
						'message-submit':{
							selector:'.step.submit',
							init:function(merlin,dom){
								tc.jQ.ajax({
									type:'POST',
									url:'/project/message/add',
									data:merlin.options.data,
									context:merlin,
									dataType:'text',
									success:function(data,ts,xhr){
										if(data == 'False'){
											window.location.hash = 'project_conversation,message-submit-error';
											return false;
										}
										project.dom.trigger('add-new-message',this.options.data);
										window.location.hash = 'project_conversation,message';
									}
								});
							}
						},
						'message-submit-error':{
							selector:'.step.submit-error',
							init:function(){
								tc.timer(1000,function(){
									window.location.hash = 'project_conversation,message';
								});
							}
						}
					}
				});
			};
		
			this.build_merlin();
		{% endif %}
		
		return { 
			show: widget.show,
			hide: widget.hide
		};
	};
</script>

