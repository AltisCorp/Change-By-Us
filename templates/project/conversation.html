<div class="box conversation">
	<div class="conversation-controls clearfix">
		<a class="rss-btn" href="#"><span><abbr>RSS</abbr></span></a>
		
		{% if d.template_data.project.data.info.messages['total'] > 0 %}
			<div class="filters">
				<select>
					<option>All messages</option>
					<option>XXXX</option>
					<option>XXXX</option>
				</select>
			</div>
		{% endif %}
		
		<div class="main merlin submit-message">
			<div class='step message clearfix'>
				<div class="conversation-input">
					{% if d.template_data.project.data.info.messages['total'] > 0 %}
						<label class="fancy-caps">Join <span>the</span> Conversation</label>
					{% else %}
						<label class="fancy-caps">Start <span>the</span> Conversation</label>
					{% endif %}
					<textarea class='message-input' cols="54" rows="1"></textarea>
					<p class="hint">Post your update as a comment or add links to photos and videos.</p>
				</div>
				<div class="primary-action">
					<!--<button class="rounded-button">Update</button>-->
					<a class="ca-btn submit-button" href="#">
						<span>Post</span>
					</a>
				</div>
			</div>
			<div class='step submit clearfix' style='display:none;'>
				<p>Thank you for submitting a message!</p>
				<p><img src='/static/images/loader32x32.gif' /></p>
			</div>
		</div>
	</div>
	
	{% if d.template_data.project.data.info.messages['n_returned'] > 0 %}
		<ol class="comment-stack">
			{% for message in d.template_data.project.data.info.messages['items'] %}
				<li>
					{% if d.template_data.project_user.data.is_project_admin %}
						<a class="close" href="#"><span>Close</span></a>
					{% endif %}
					<div class="membrane">
						<div class="thumb">
							<img src="http://placehold.it/50x50" alt=" " class="avatar"/>
						</div>
						<div class="main">
							{% if message.message_type == 'join' %}
								<cite class="meta-hd"><strong>{{ message.owner.name }}</strong> joined the project!</cite>
							{% elif message.message_type == 'comment' %}
								<cite class="meta-hd"><strong>{{ message.owner.name }}</strong> says</cite>
							{% endif %}
							
							{% if message.idea %}
								<div class="note-card">
									<cite class="note-meta-hd"></cite>
									<blockquote>
										<p>{{ message.idea.message }}</p>
									</blockquote>
									<cite class="note-meta-ft"></cite>
								</div>
							{% endif %}
							
							<blockquote class="serif">
								<p>{{ message.body }}</p>
							</blockquote>
							<!-- TODO calculate time since based on {{ message.created }} -->
							<!--<cite class="meta-ft">XXXX ago</cite>-->
							<cite class="meta-ft">Created {{ message.created }}</cite>
						</div>
					</div>
				</li>
			{% endfor %}
		</ol>
		<div class="load-more">
			<a href="#"><span>Load older posts</span></a>
		</div>
	{% endif %}

</div>

<li class='template-content message-markup'>
	{% if d.template_data.project_user.data.is_project_admin %}
		<a class="close" href="#"><span>Close</span></a>
	{% endif %}
	<div class="membrane">
		<div class="thumb">
			<img src="http://placehold.it/50x50" alt=" " class="avatar"/>
		</div>
		<div class="main">
			<!-- <cite class="meta-hd"><strong></strong> joined the project!</cite> -->
			<!-- <cite class="meta-hd"><strong>XXXX XXXX</strong> says</cite> -->
			
			<blockquote class="serif">
				<p class='message-body'></p>
			</blockquote>
			<cite class="meta-ft">Created Just Now...</cite>
		</div>
	</div>
</li>

<div class='modal-content add-message-no-user'>
	<p>You must <a href='/join'>register</a> or <a href='/login'>login</a> with Give a Minute in order to add a goal to this project.</p>
	<a class='close' href="#"><span>close</span></a>
</div>

<script>
	if(!tc){ var tc = {}; }
	if(!tc.gam){ tc.gam = {}; }
	if(!tc.gam.project_widgets){ tc.gam.project_widgets = {}; }
	tc.gam.project_widgets.conversation = function(project,dom,deps,options){
		var widget;
		tc.util.log("project.conversation");
		this.options = tc.jQ.extend({name:'conversation'},options);
		this.dom = dom;
		widget = tc.gam.widget(this,project);
		
		this.components = {
			merlin:null
		};
		
		this.elements = {
			userprompt: this.dom.find(".conversation-input label"),
			textpane: this.dom.find(".conversation-input textarea"),
			message_stack:this.dom.find("ol.comment-stack")
		};
		
		this.handlers = {
			userprompt_click: function(e, d) {
				e.data.me.elements.textpane.focus();
			},
			add_new_message:function(e,d){
				tc.util.dump('conversation.handlers.add_new_message');
				tc.util.dump(e.data.me.elements.message_stack);
				var message;
				message = generate_message_markup(d);
				message.hide();
				e.data.me.elements.message_stack.prepend(message);
				message.slideDown(500);
			}
		};
		
		project.dom.bind('add-new-message',{me:this},this.handlers.add_new_message);
		this.elements.userprompt.bind("click", { project:project,me:this },this.handlers.userprompt_click);
		this.elements.textpane.autoGrow();
		
		function generate_message_markup(data){
			var markup;
			markup = tc.jQ('.template-content.message-markup').clone().removeClass('template-content');
			markup.find('p.message-body').text(data.message);
			return markup;
		}
		
		function build_merlin(){
			//if(!options.app.app_page.user){
			//	options.app.components.modal.show({
			//		source_element:tc.jQ('.modal-content.add-message-no-user'),
			//		init:function(modal,callback){
			//			if(tc.jQ.isFunction(callback)){
			//				callback(modal);
			//			}
			//		}
			//	});
			//	return false;
			//}
			tc.util.log('conversation.build_merlin')
			return new tc.merlin(options.app,{
				dom:dom.find('.merlin.submit-message'),
				next_button:dom.find('a.submit-button'),
				first_step:'message',
				data:{
					message:null,
					project_id:null
				},
				steps:{
					'message':{
						selector:'.step.message',
						next_step:'submit',
						inputs:{
							message:{
								selector:'textarea.message-input',
								validators:['min-3','max-200','required'],
								hint:'',
								handlers:{
									focus:function(e,d){
										if (tc.validator_utils.isEmpty(tc.jQ(this).val())) {
											e.data.me.dom.find(".conversation-input label").hide();
										}
									},
									blur:function(e,d){
										if (tc.validator_utils.isEmpty(tc.jQ(this).val())) {
											e.data.me.dom.find(".conversation-input label").show();
										}
									}
								}
							}
						},
						init:function(merlin,dom){
							merlin.current_step.inputs.message.dom.val('').removeClass('has-been-focused').removeClass('has-attempted-submit');
						},
						finish:function(merlin,dom){
							tc.util.dump(merlin.current_step.dom.height());
							merlin.dom.find('.step.submit').css('height',merlin.current_step.dom.height())
							merlin.options.data = tc.jQ.extend(merlin.options.data,{
								project_id:merlin.app.app_page.data.project.project_id,
								message:merlin.current_step.inputs.message.dom.val()
							});
						}
					},
					'submit':{
						selector:'.step.submit',
						init:function(merlin,dom){
							tc.jQ.ajax({
								type:'POST',
								url:'/project/message/add',
								data:merlin.options.data,
								context:merlin,
								dataType:'text',
								success:function(data,ts,xhr){
									if(data == 'False'){
										return false;
									}
									project.dom.trigger('add-new-message',this.options.data);
									window.location.hash = 'message';
								}
							});
						}
					}
				}
			});
		}
		
		if (!this.components.merlin) {
			this.components.merlin = build_merlin();
		}
		
		return { 
			show:function(propagate){
				widget.show(propagate);
				if (!me.components.merlin) {
					me.components.merlin = build_merlin();
				}
			},
			hide:widget.hide
		};
	};
</script>

