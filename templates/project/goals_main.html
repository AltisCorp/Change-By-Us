<!-- begin goals-main -->	
<div class="box goals-main">
	{% include 'project/goals_widget_hd.html' %}
	
	<div class="goals-display" style="{% if not d.template_data.project.data.info.goals['items']|length > 0 %}display:none;{% endif %}">
		<h3 class="fancy-caps"><span>The</span> Active Goal <span>for this</span> Project</h3>
		<div class="carousel">
			<div class="scrollable">
				<ul class="items">
					{% for goal in d.template_data.project.data.info.goals['items'] %}
						<li>
							<div class="goal-card">
								{% if d.template_data.project_user.is_project_admin %}
									<a class="close" href="#close,{{ goal.goal_id }}"><span>Close</span></a>
								{% endif %}
								<p>{{ goal.text }}</p>
								<div class="meta">
									<dl>
										<dt>Timeframe</dt>
										<dd>{{ goal.timeframe }}</dd>
										
										<dt>Point Person</dt>
										<dd><a href='/useraccount/{{ goal.owner.u_id }}'>{{ goal.owner.name }}</a></dd>
									</dl>
								</div>
							</div>
						</li>
					{% endfor %}
				</ul>
			</div>
			<div class="carousel-controls">
				<a class="next" href="#">
					<span>Next</span>
				</a>
			</div>
		</div>
	</div>
	
	<div class="goals-empty" style="{% if d.template_data.project.data.info.goals['items']|length > 0 or not d.template_data.project_user.data.is_member %}display:none;{% endif %}">
		<h3 class="fancy-caps">Make <span>an</span> Active Goal <span>for this</span> Project</h3>
		<div class="empty-state-box big">
			<a class="close" href="#"><span>Close</span></a>
			<p>Goals help you define what you want to do and get your project done more efficiently. Why not <a href="#show,goals_add">add a goal now?</a></p>
		</div>
	</div>
	
</div>

<li class='template-content goal'>
	<div class="goal-card">
		{% if d.template_data.project_user.data.is_project_admin %}
			<a class="close" href="#close,"><span>Close</span></a>
		{% endif %}
		<p class='goal-title'></p>
		<div class="meta">
			<dl>
				<dt>Timeframe</dt>
				<dd class='timeframe'></dd>
				<dt>Point Person</dt>
				<dd class='owner-name'></dd>
			</dl>
		</div>
	</div>
</li>

<script>
	if(!tc){ var tc = {}; }
	if(!tc.gam){ tc.gam = {}; }
	if(!tc.gam.project_widgets){ tc.gam.project_widgets = {}; }
	
	tc.gam.project_widgets.goals_main = function(project,dom,deps,options){
		var widget;
		tc.util.log("project.goals_main");
		this.project = project;
		this.options = tc.jQ.extend({name:'goals_main'},options);
		this.dom = dom;
		widget = tc.gam.widget(this,project);
		this.handlers = {
			carousel_scrolled: function(e, index) {
				
			},
			goals_refresh:function(e){
				tc.util.dump('goals_main.goals-refresh');
				tc.jQ.ajax({
					type:'GET',
					url:'/project/goals',
					data:{
						project_id:e.data.me.project.data.project_id
					},
					context:e.data.me,
					dataType:'text',
					success:function(data,ts,xhr){
						var d;
						try{
							d = tc.jQ.parseJSON(data);
						}catch(e){
							return;
						}
						this.handle_goals(d);
					}
				});
			}
		};
		
		this.handle_goals = function(data){
			var i, list, temphtml;
			list = this.dom.find('ul.items');
			this.dom.find('.counter').text(data.length);
			this.carousel.getItems().remove();
			for(i in data){
				temphtml = tc.jQ('.template-content.goal').clone().removeClass('template-content');
				temphtml.css('width','512px');
				temphtml.find('.goal-title').text(data[i].text);
				temphtml.find('.timeframe').text(data[i].timeframe);
				temphtml.find('.owner-name').html("<a href='/useraccount/"+data[i].owner.u_id+"'>"+data[i].owner.name+"</a>");
				this.carousel.addItem(temphtml);
			}
			this.carousel.end();
		};
		
		if(this.dom.find(".carousel").length){
			this.carousel = new tc.carousel({
				element: this.dom.find(".carousel")
			}).carousel;
			if(this.carousel){
				this.carousel.onSeek(this.handlers.carousel_scrolled);
			}
		}
		
		project.dom.bind('goals-refresh',{me:this},this.handlers.goals_refresh);
		
		return {
			show:widget.show,
			hide:widget.hide
		};
	};
	
</script>
<!-- end .goals-main -->