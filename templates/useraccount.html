{% extends "./partials/base.html" %}

{% block title %}
Give A Minute - User Account
{% endblock title %}

{% block continent %}

<div class='continent user-account'>
	<div class='headlands'>

	</div>

	<div class='midlands merlin clearfix'>
		<div class="west">
			<div class="box user-account-nav">
				<div class="hd clearfix">
					<div class="thumb">
						{% if d.template_data.user_activity.data.user.image_id %}
							<img width='30' src='/images/{{ d.template_data.user_activity.data.user.image_id % 10 }}/{{ d.template_data.user_activity.data.user.image_id }}.png' alt="{{ d.template_data.user_activity.data.user.name }}" class='avatar'/>
						{% else %}
							<img width='30' src="/static/images/thumb_genAvatar30.png" alt="{{ d.template_data.user_activity.data.user.name }}" class="avatar"/>
						{% endif %}
					</div>
					<div class="user-info">
						{{ d.template_data.user_activity.data.user.name }}
					</div>
				</div>
				<div class="bd">
					<ul class="tabs">
						<li class="activity unread"><a href="#user-account,activity">Activity <span class="counter">{{ d.template_data.user_activity.data.projects|length + d.template_data.user_activity.data.ideas|length }}</span></a></li>
						
						{% if d.template_data.user %}
							<li class="messages"><a href="#user-account,messages">Messages <span class="counter">{{ d.template_data.user_activity.data.messages|length }}</span></a></li>
							<li class="account"><a href="#user-account,account">Account</a></li>
						{% endif %}
					</ul>
				</div>
			</div>
		</div>
		<div class="east">
			<div>
			
				<div class="activity-view step">
					<div class="box my-projects">
						<div class="hd">
							<h2><span class="light">My</span> Projects <span class="counter">{{ d.template_data.user_activity.data.projects|length }}</span></h2>
						</div>
						<div class="bd">
							
							{% for project in d.template_data.user_activity.data.projects %}
							
								<div class='clearfix project-header'>
									<div class="thumb">
										{% if project.image_id and not project.image_id == -1  %}
											<img width='80' src='/images/{{ project.image_id % 10 }}/{{ project.image_id }}.png' alt="" class='proj'/>
										{% else %}
											<img width='80' src="/static/images/thumb_genAvatar100.png" alt="" class="proj"/>
										{% endif %}
										<span class="overlay-tag"></span>
									</div>
									<div class="tools">
										<div class="members">
											<a href="/project/{{ project.project_id }}/#show,members">Members <span class="counter">{{ project.num_members }}</span></a>
										</div>
									</div>
									<div class="main">
										<h1><a href="/project/{{ project.project_id }}">{{ project.title }}</a></h1>
										<cite class="meta"><span class="fancy-caps">Created <span>by</span></span> <strong>XXXXX</strong></cite>
										<div class="sub-ft">
											<div class="facebook">
												<!--
												<script src="http://connect.facebook.net/en_US/all.js#xfbml=1"></script>
												<fb:like layout="button_count" show_faces="true" width="100"></fb:like>
												-->
											</div>
										</div>
									</div>
								</div>
							
							{% endfor %}
							
						</div>
					</div>
					<div class="box my-ideas">
						<div class="hd">
							<h2><span class="light">My</span> Ideas <span class="counter">{{ d.template_data.user_activity.data.ideas|length }}</span></h2>
						</div>
						<div class="bd">
							<ul class="idea-cards">
								
								{% for idea in d.template_data.user_activity.data.ideas %}
								
									<li class="{% if loop.index % 3 == 0  %}every-third{% endif %}">
										{% if d.template_data and d.template_data.user %}
										<div class="note-card-public-controls">
											{% if d.template_data.user.data.projects|length > 0 %}
												<a class="invite rounded-button" href="#invite,{{ idea.idea_id }},{{ idea.owner.name }}">Invite</a>
											{% endif %}
											<span class="flag">Flag as Inappropriate</span>
										</div>
										{% endif %}
										<div class="note-card">
											<div class="membrane">
												<!-- <a class="close" href="#"><span>Close</span></a> -->
												<cite class="note-meta-hd">{% if idea.owner %}<strong>{{ idea.owner.name|truncate(18) }}</strong> says &mdash;{% endif %}</cite>
												<blockquote><p>{{ idea.message|truncate(180) }}</p></blockquote>
												<!-- <cite class="note-meta-ft">Posted <strong>02.04.2011</strong> at <strong>02:45pm</strong> via <strong>Web</strong></cite> -->
												<cite class="note-meta-ft">Posted <strong>{{ idea.created }}</strong> via <strong>{{ idea.submission_type }}</strong></cite>
											</div>
										</div>
									</li>
								
								{% endfor %}
								
							</ul>
						</div>
					</div>
				</div><!--end activity-view-->
				
				{% if d.template_data.user %}
				
					<div class="messages-view step" >
						<div class="box messages">
							<div class="hd">
								<h2>Messages</h2>
							</div>
							<div class="bd">
								<ol class="message-stack">
									
									{% for message in d.template_data.user_activity.data.messages %}
										{% if message.message_type == "member_comment" %}
											<li class="message-item">
												<a class="close" href="#"><span>Close</span></a>
												<div class="thumb">
													{% if message.owner.image_id %}
														<img width='50' src='/images/{{ message.owner.image_id % 10 }}/{{ message.owner.image_id }}.png' alt="{{ message.owner.name }}" class='avatar'/>
													{% else %}
														<img width='50' src="/static/images/thumb_genAvatar50.png" alt="{{ message.owner.name }}" class="avatar"/>
													{% endif %}
												</div>
												<div class="main">
													<div class="meta">
														<cite class="sender">{{ message.owner.name }}</cite>
														<cite>{{ message.created }}</cite>
													</div>
													<blockquote class="excerpt">
														<p>{{ message.body }}</p>
													</blockquote>
												</div>
											</li>
										{% else %}
										
										{% endif %}
									{% endfor %}
									
									<!-- TODO other messsage types (?)
									
									<li class="message-item user-notification">
										<a class="close" href="#"><span>Close</span></a>
										<span class="title">You've been invited to the <strong>Green Bklyn</strong> Action Group!</span>
										<div class="controls">
											<a href="">Click to see action group</a>
										</div>
									</li>
									<!--<li class="message-item user-prompt">
										<a class="close" href="#"><span>Close</span></a>
										<h4>Sasha wants to join your Action Group!</h4>
										<p>Hey Robert, I saw your group when I went in to create something similar. I live on Church and would love to see some green on this street. I heard the city has a program where you can request plantings. Anyway, let's group up and geterdone!</p>
										<div class="controls">
											<button class="approve-btn">Approve</button>
											<a href="">Ignore</a>
										</div>
									</li>--><!--
									<li class="message-item user-notification">
										<a class="close" href="#"><span>Close</span></a>
										<span class="title">New Member! Your group now has 25 total!</span>
										<div class="controls">
											<a href="">Click to see action group</a>
										</div>
									</li>-->
									
								</ol>
							</div>
							<div class="load-more">
								<a href=""><span>Load older messages</span></a>
							</div>
						</div>
						<div class="box preferences">
							<div class="hd">
								<h3>Preferences</h3>
							</div>
							<div class="bd">
								<ul class="checklist">
									<li>
										<input type="radio" name="pref-emails-option" id="pref-emails-daily"/>
										<label for="pref-emails-daily">Get a daily digest e-mail</label>
									</li>
									<li>
										<input type="radio" name="pref-emails-option" id="pref-no-emails"/>
										<label for="pref-no-emails">No e-mails</label>
									</li>
								</ul>
							</div>
						</div>
					</div><!-- end messages-view -->
				
					<div class="account-view step merlin">
						
						<div class="box user-account">
							<div class="hd">
								<h2>Account</h2>
							</div>
							<div class="bd step edit-account-details">
								<form action="" method="POST" class="account-info">
									<div class="thumb user-pic">
										{% if d.template_data.user_activity.data.user.image_id %}
											<img width='50' src='/images/{{ d.template_data.user_activity.data.user.image_id % 10 }}/{{ d.template_data.user_activity.data.user.image_id }}.png' alt="{{ d.template_data.user_activity.data.user.name }}" class='avatar'/>
										{% else %}
											<img width='50' src="/static/images/thumb_genAvatar50.png" alt="{{ d.template_data.user_activity.data.user.name }}" class="avatar"/>
										{% endif %}
										<div class="addphoto">
											<a href="#">Change<br /><span>Photo</span></a>
										</div>
									</div>
									<div class="user-details">
										<div class="fields">
											<div class="row row-first-name">
												<label>First name</label>
												<input type="text" value="{{ d.template_data.user.data.f_name }}" />
											</div>
											<div class="row row-last-name">
												<label>Last name</label>
												<input type="text" value="{{ d.template_data.user.data.l_name }}" />
											</div>
											<div class="row row-email clearfix">
												<label>E-mail address</label>
												<input type="text" value="{{ d.template_data.user.data.email }}" />
											</div>
											<div class="row row-change-pass clearfix">
												<label>Change Password</label>
												<input type="password" value="" />
											</div>
										</div>
										<div>
											<input class="rounded-button save-button" type="submit" value="Save Changes"/>
										</div>
									</div>
								</form>
								<div class="social-networking facebook-connected">
									<div class="social-connect-wrapper">
										<a href="" class="connect-facebook"></a>
										<a href="" class="disconnect">Disconnect</a>
									</div>
									<div class="social-connect-wrapper">
										<a href="" class="connect-twitter"></a>
										<a href="" class="disconnect">Disconnect</a>
									</div>
								</div>
							</div>
							<div class="bd step submit-account-details">
								<p>Processing your account details&hellip;</p>
								<p><img src='/static/images/loader32x32.gif' /></p>
							</div>
							<div class="bd step account-details-submitted">
								<p>Your account details have been updated!</p>
							</div>
							<div class="bd step account-details-error">
								<p>There was an error updated your account details.</p>
							</div>
						</div>
						
					</div><!--end account-view-->
				
				{% endif %}
				
			</div>	
		</div>
	</div>

	<div class='foothills'>

	</div>
	
	<div class='template-content modal-content upload-image'>
		<div class='step'>
			<h2><strong>Upload</strong> a photo for your account.</h2>
			<div>
				<p>Photos should be <strong>under 1MB</strong> please. (We also crop photos to <strong>90px by 90px</strong>)</p>
			</div>
			<div class="file-uploader"></div>
		</div>
		<a class='close' href="#"><span>close</span></a>
	</div>
	
</div>

{% endblock continent %}

{% block page_js %}
<script>
	app_page.features.push(function(app){
		tc.util.log('Give A Minute: User Account');
		
		tc.util.log("User Account Data!!!!!!!!!!!!");
		tc.util.dump({{ d.template_data.user_activity.json }});
		
		{% if d.template_data.user %}
			tc.util.log("Logged in User:");
			tc.util.dump({{ d.template_data.user.json }});
		{% else %}
			tc.util.log("Not logged in!");
		{% endif %}

		app.components.user_page_merlin = new tc.merlin(app,{
			name: "user-account",
			dom:tc.jQ('.midlands.merlin'),
			first_step:'activity',
			steps:{
				'activity':{
					selector:'.activity-view',
					init:function(merlin,dom){
						tc.jQ('ul.tabs li').removeClass('active').filter(".activity").addClass("active");
					}
				},
				'messages':{
					selector:'.messages-view',
					init:function(merlin,dom){
						tc.jQ('ul.tabs li').removeClass('active').filter(".messages").addClass("active");
						dom.find(".preferences .checklist input[type='radio']").unbind("change").bind("change", function(e, d) {
							var pref;
							switch (tc.jQ(e.target).attr("id")) {
								case "pref-emails-daily":
									pref = "digest";
									break;
								case "pref-no-emails":
									pref = "none";
									break;
							}
							if (!pref) {
								return false;
							}
							tc.jQ.ajax({
								type:"POST",
								url:"/useraccount/messageprefs",
								data:{
									pref: pref
								},
								context:merlin,
								dataType:"text",
								success: function(data, ts, xhr) {
									if (data == "False") {
										return false;
									}
								}
							});
						});
					}
				},
				'account':{
					selector:'.account-view',
					init:function(merlin,dom){
						tc.jQ('ul.tabs li').removeClass('active').filter(".account").addClass("active");
						window.location.hash = "account-info,edit-account-details";
					}
				}
			}
		});
		
		{% if d.template_data.user %}
			app.components.account_merlin = new tc.merlin(app,{
				name: "account-info",
				dom:tc.jQ(".account-view.merlin"),
				first_step: "edit-account-details",
				data: {
					f_name: app.app_page.user.f_name,
					l_name: app.app_page.user.l_name,
					email: app.app_page.user.email,
					password: null,
					image_id: app.app_page.user.image_id || null
				},
				steps: {
					"edit-account-details":{
						selector: ".step.edit-account-details",
						inputs: {
							first_name:{
								selector:'.row-first-name input',
								validators:["required"]
							},
							last_name:{
								selector:".row-last-name input",
								validators:["required"]
							},
							email:{
								selector:".row-email input",
								validators:["required"]
							},
							password:{
								selector:".row-change-pass input"
							}
						},
						init: function(merlin, dom) {
							dom.find('.save-button').bind('click',{merlin:merlin,dom:dom},function(e,d){
								e.preventDefault();
								if(dom.hasClass('invalid')){
									return;
								}
								window.location.hash = 'account-info,submit-account-details';
							});
							
							tc.jQ(document).unbind('create-image-uploaded').bind('create-image-uploaded',{merlin:merlin}, function(e, d){
								e.data.merlin.app.components.modal.hide();
								if(d.responseJSON.thumbnail_id){
									merlin.dom.find('.user-pic img').attr('src','/images/'+(d.responseJSON.thumbnail_id % 10)+'/'+d.responseJSON.thumbnail_id+'.png');
									tc.jQ(".user-account-nav img.avatar").attr('src','/images/'+(d.responseJSON.thumbnail_id % 10)+'/'+d.responseJSON.thumbnail_id+'.png');
									merlin.options.data.image_id = d.responseJSON.thumbnail_id;
								}
							});
						},
						finish: function(merlin, dom) {
							var change_password;
							change_password = merlin.current_step.inputs.password.dom.val();
							
							merlin.options.data = tc.jQ.extend(merlin.options.data, {
								f_name: merlin.current_step.inputs.first_name.dom.val(),
								l_name: merlin.current_step.inputs.last_name.dom.val(),
								email: merlin.current_step.inputs.email.dom.val(),
								password: change_password.length ? change_password : null
							});
						}
					},
					"submit-account-details":{
						selector:".step.submit-account-details",
						init: function(merlin, dom) {
							tc.jQ.ajax({
								type:"POST",
								url:"/useraccount/edit",
								data:merlin.options.data,
								context:merlin,
								dataType:"text",
								success: function(data, ts, xhr) {
									if (data == "False") {
										window.location.hash = "account-info,account-details-error";
										return false;
									}
									//window.location.hash = "account-info,account-details-submitted";
									window.location.reload(true);
								}
							});
						}
					},
					"account-details-submitted":{
						selector:".step.account-details-submitted",
						init: function(merlin, dom) {
							tc.timer(1000, function() {
								window.location.hash = "user-account,account";
							});
						}
					},
					"account-details-error":{
						selector:".step.account-details-error",
						init: function(merlin, dom) {
							
						}
					}
				}
			});
			
			tc.jQ('.addphoto a').bind('click',{
				app:app,
				source_element:tc.jQ('.modal-content.upload-image'),
				init:function(modal,callback){
					var uploader = new qq.FileUploader({
						element: modal.options.element.find('.file-uploader').get(0),
						action: '/create/photo',
						onComplete: function(id, fileName, responseJSON){

							tc.jQ(document).trigger('create-image-uploaded',{
								id:id,
								fileName:fileName,
								responseJSON:responseJSON
							});

							return true;
						}
					});
					if(tc.jQ.isFunction(callback)){
						callback(modal);
					}
				}
			},function(e,d){
				e.preventDefault();
				e.data.app.components.modal.show(e.data);
			});
			
		{% endif %}
		
	});
</script>
<script src="/static/js/prettyCheckboxes.js" type="text/javascript"></script>
<script type="text/javascript">
tc.jQ(document).ready(function(){
	tc.jQ('input[type=checkbox],input[type=radio]').prettyCheckboxes();
});
</script>
{% endblock page_js %}